- @permissions = Permission.cached_permissions_by(@resource) #tmp# @resource.permissions

%table.permissions
  %tbody
    %tr
      %th
        = _("Last name, first name") + ":"
      %th{:colspan => 2}
        = _("Permissions") + ":"
      %th
    %tr
      %td
        %strong
          = _("Individuals")
      %td
        = _("View")
      %td
        = _("Edit")
      %td
        = _("Full resolution")
  %tbody#user_permissions
    = render :partial => "/permissions/edit", :collection => @permissions.select{|x| x.subject_type == "User"}, :as => :permission
  %tbody
    %tr.adder
      %td
        = _("Add user")
      %td{:colspan => 4}
        %input#new_user
    %tr
      %td{:colspan => 5}
        %p{:style => "font-size: 0.9em; line-height: 2em;"}
          = _("Only users that have logged into the system before can be chosen here.")
  %tbody
    %tr
      %td
        %strong
          = _("Groups")
      %td
        = _("View")
      %td
        = _("Edit")
      %td
        = _("Full resolution")
  %tbody#group_permissions
    = render :partial => "/permissions/edit", :collection => @permissions.select{|x| x.subject_type == "Group"}, :as => :permission
  %tbody
    %tr.adder
      %td
        = _("Add group")
      %td{:colspan => 4}
        %input#new_group
  %tbody
    %tr
      %td
        %strong
          = _("General")
      %td
        = _("View")
      %td
        = _("Edit")
      %td
        = _("Full resolution")
  %tbody#anyone_permissions
    = render :partial => "/permissions/edit", :collection => @permissions.select{|x| x.subject_type.nil?}, :as => :permission

:javascript
  $(function() {
    function create_permission(data, type){
  		$.ajax({
  			url: '#{url_for([@resource, :permissions])}',
  			data: data,
  			type: "post",
  			success: function(response){
          $("input#new_"+type).val("");
          $(response).appendTo('tbody#'+type+'_permissions').effect('highlight');
  			}
  		});
    }

    $("input#new_user").autocomplete({
      source: "/users",
      minLength: 3,
      select: function(event, ui) {
        create_permission({user_id: ui.item.id}, 'user');
      }
    });
    
    $("input#new_group").autocomplete({
      source: "/groups",
      minLength: 3,
      select: function(event, ui) {
        create_permission({group_id: ui.item.id}, 'group');
      }
    });
    
    $("table.permissions input:checkbox").live('click', function(){
  		$.ajax({
  			url: $(this).attr("path"),
  			data: {checked: $(this).is(":checked")},
  			type: "put",
  			dataType: "script"
  		});
      $(this).siblings("input:checkbox").attr('checked', false);
    });
    
    $("table.permissions a[data-method='delete']").live('ajax:success', function(){
      $(this).closest("tr").fadeOut();
    });
  });
